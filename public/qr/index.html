<!doctype html>
<html>

<head>
    <title>Juke Box by Test Lab</title>
    <link rel="apple-touch-icon" sizes="57x57" href="assets/img/icons/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="assets/img/icons/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="assets/img/icons/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="assets/img/icons/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="assets/img/icons/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="assets/img/icons/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="assets/img/icons/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="assets/img/icons/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/img/icons/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="assets/img/icons/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/img/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="assets/img/icons/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/img/icons/favicon-16x16.png">
    <meta name="msapplication-TileColor" content="#191414">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#191414">
    <link rel="manifest" href="/manifest.json">
    <style type="text/css">
        #login,
        #loggedin {
            display: none;
        }

        .text-overflow {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            width: 500px;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css?family=Fira+Sans:400,700,900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/styles.min.css?h=208d4826ec51fd9503a6c3662b510a4d">
    <meta name="theme-color" content="#191414">
    <link rel="manifest" href="/manifest.json">
    <style>
        @media (orientation: landscape) {
            #left {
                background-position: left center;
            }
        }

        @media (orientation: portrait) {
            #left {
                background-position: center top;
            }
        }

        #time_bar {
            transition: width 1 s;
        }
    </style>
</head>

<body style="background-color:#191414;">
    <div id="login" class="container">
        <div class="row align-items-center" style="height: 99vh">
            <div class="col-12 justify-content-center text-center">
                <img src="/assets/img/icons/juke.png" style=" width: auto; max-width: 100%;">
                <h3 class="mb-5 text-center text-white-50  text-uppercase">Insira o c√≥digo exibido na sua JukeBox</h3>

                <div class="form-group mb-5">
                    <label for="inputPassword2" class="sr-only">Code</label>
                    <input type="number" class="form-control text-white bg-dark" id="inputCode"
                        placeholder="Insira o seu codigo">
                </div>
                <button onclick="validateForm()" value="submit" class="btn text-uppercase text-white"
                    style=" width: 100%; font-size: 1.5em; background-color: #1DB954;">Login pelo
                    Spotify</button>
                </button>
            </div>

        </div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>


        <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.4.1.min.js"
            integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
        <script>
            var t,
                id,
                music_time;
            (function () {

                /**
                 * Obtains parameters from the hash of the URL
                 * @return Object
                 */
                function getHashParams() {
                    var hashParams = {};
                    var e, r = /([^&;=]+)=?([^&;]*)/g,
                        q = window.location.hash.substring(1);
                    while (e = r.exec(q)) {
                        hashParams[e[1]] = decodeURIComponent(e[2]);
                    }
                    return hashParams;
                }
      /*
            var userProfileSource = document.getElementById('user-profile-template').innerHTML,
              userProfileTemplate = Handlebars.compile(userProfileSource),
              userProfilePlaceholder = document.getElementById('user-profile');
      
            var oauthSource = document.getElementById('oauth-template').innerHTML,
              oauthTemplate = Handlebars.compile(oauthSource),
              oauthPlaceholder = document.getElementById('oauth');
      
            */var params = getHashParams();

                var access_token = params.access_token,
                    refresh_token = params.refresh_token,
                    error = params.error;

                if (error) {
                    alert('There was an error during the authentication');
                } else {
                    if (access_token) {
                        // render oauth info
                        /*  oauthPlaceholder.innerHTML = oauthTemplate({
                            access_token: access_token,
                            refresh_token: refresh_token
                          });*/
                        console.log("loop")
                        window.t = refresh_token
                        loop()
                        myVar = setInterval(loop, 1000);

                        /*$.ajax({
                          url: 'https://api.spotify.com/v1/me',
                          headers: {
                            'Authorization': 'Bearer ' + access_token
                          },
                          success: function (response) {
                            userProfilePlaceholder.innerHTML = userProfileTemplate(response);
              
                            //$('#login').hide();
                            //$('#loggedin').show();
                          }
                        });*/
                    } else {
                        // render initial screen
                        $('#login').show();
                        $('#box').hide();
                        //$('#loggedin').hide();
                    }
                }
            })();




            function loop() {
                try {
                    $.ajax({
                        url: '/currently-playing',
                        headers: {
                            'access_token': access_token,
                            'music_id': window.id
                        },
                        statusCode: {
                            200: function (response) {
                                console.log(response)

                                if (response.body != 'ok') {
                                    try {
                                        console.log(response)
                                        if (response.body.item.id != window.id) {
                                            //console.log(response)
                                            //console.log("ID:" + response.body.item.id)
                                            document.querySelector('#left div').style.backgroundImage = "url('" + response.body.item.album.images[0].url + "')"
                                            document.querySelector("#right p").innerText = response.body.item.album.artists[0].name
                                            document.querySelector("#right h1").innerText = response.body.item.name
                                            like(response.body.item.id)
                                            window.id = response.body.item.id
                                            window.music_time = response.body.item.duration_ms
                                            document.querySelector('#duration_ms').innerText = convertMS(window.music_time)

                                            document.querySelector('#box').style.background = "linear-gradient(90deg, " + response.color[0] + "FF 0%, " + response.color[0] + "B3   100%)"
                                            document.querySelector('#right div').style.color = response.color[1]

                                        }
                                    } catch (error) {
                                        console.log(error)
                                        refreshToken()
                                    }
                                    $('#login').hide();
                                    $('#box').show();
                                }
                                //console.log(response.progress_ms + " - " + window.music_time + " | " + (response.progress_ms / window.music_time) * 100)
                                if (response.progress_ms) {
                                    document.querySelector("#time_bar").style.width = ((response.progress_ms / window.music_time) * 100) + "%"
                                    document.querySelector('#progress_ms').innerText = convertMS(response.progress_ms)
                                }
                                // "<div style='height: 1px;background-color: #ffffff;'><div class='d-xl-flex'><p class='mr-auto'>2:80</p><p class='ml-auto'>3:10</p></div><div class='border rounded' style='background-color: #ffffff;height: 4px;width: 90%;'></div></div>"

                            }
                        }
                    })
                } catch (error) {
                    console.log("Erro na api /currently-playing - " + error)
                    refreshToken()
                }
            }

            function like(id) {

                $.ajax({
                    url: 'https://api.spotify.com/v1/me/tracks/contains?ids=' + id,
                    headers: {
                        'Authorization': 'Bearer ' + access_token
                    },
                    success: function (response) {

                        if (response[0] == true) {
                            try { document.querySelector("#like").classList.remove("far") } catch (error) { }
                            document.querySelector("#like").classList.add("fas")
                        } else {
                            try { document.querySelector("#like").classList.remove("fas") } catch (error) { }
                            document.querySelector("#like").classList.add("far")
                        }
                    }
                })

            }

            function refreshToken() {
                $.ajax({
                    url: '/refresh_token',
                    data: {
                        'refresh_token': window.t
                    }
                }).done(function (data) {
                    access_token = data.access_token;
                    console.log(access_token)
                });
            }

            function convertMS(milliseconds) {
                var minute, seconds;
                seconds = Math.floor(milliseconds / 1000);
                minute = Math.floor(seconds / 60);
                seconds = seconds % 60;
                minute = minute % 60;
                if (seconds < 10) {
                    seconds = '0' + seconds
                }
                return (minute + ":" + seconds)
            }

            function validateForm() {
                if (document.getElementById("inputCode").value.length == 6) {
                    console.log(document.getElementById("inputCode").value)
                    window.location.href = ("/login?qrcode=" + document.getElementById("inputCode").value)
                } else {
                    alert("the code must have 6 numbers")
                }
            }


        </script>
        <script src="https://kit.fontawesome.com/edca28291c.js" crossorigin="anonymous"></script>
</body>

</html>